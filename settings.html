<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Einstellungen</title>
	<link rel="stylesheet" href="./assets/css/styles.css">
	<link rel="stylesheet" href="./assets/css/dark-styles.css">
	<link rel="stylesheet" href="./assets/css/line-colors.css">
	<link rel="shortcut icon" type="image/x-icon" href="./assets/branding/favicon.ico">
	<link rel="manifest" href="/manifest.json" type="application/json" >
	<meta name="theme-color" content="#000">
</head>

<body class="bodyWithPopup coloredbody">

<center>

<nav id="navbar"><div class="tabs"><span class="active">&nbsp;Einstellungen&nbsp;</span></div><div class="iconbar bigonly"><a href="#" onclick="history.go(-1)">Schließen</a></div><div class="iconbar"><a href="#" onclick="history.go(-1)"><img src="./assets/icons/close.svg" class="mediumicon"></a></div></nav>

<br>

	
<div class="textonly">

	<h3>Style</h3>
	<div class="listcontainer">
		<div class="listitem"><div class="listimagecontainer"><img src="./assets/icons/wallpaper.svg"></div><div class="listitemtext">Wallpaper<br><small class="disabled">Das gewählte Bild wird auf der Startseite angezeigt.</small></div></div>
		<div class="listitem imagecarousel">
			<div class="selectwallpaper"  data-id="wallpaper1" style="background-image: url(./assets/wallpapers/wallpaper1.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="wallpaper2" style="background-image: url(./assets/wallpapers/wallpaper2.jpg); background-position-y: 90%;"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="wallpaper3" style="background-image: url(./assets/wallpapers/wallpaper3.jpg); background-position-y: 40%;"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="wallpaper4" style="background-image: url(./assets/wallpapers/wallpaper4.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="wallpaper5" style="background-image: url(./assets/wallpapers/wallpaper5.jpg);  background-position-y: 90%;"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
		</div>
		<div class="listitem listswicthitem">
			<div class="switchitemtext">Zufällig auswählen</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="random-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>
	</div>
	<br>
	<div class="listcontainer">
		<div class="listitem"><div class="listimagecontainer"><img src="./assets/icons/palette.svg"></div><div class="listitemtext">Hintergrundfarbe<br><small class="disabled">Die gewählte Farbe wird auf der Startseite angezeigt.</small></div></div>
		<div class="listitem imagecarousel">
			<div class="selectwallpaper"  data-id="color1" style="background-image: url(./assets/wallpapers/color1.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color1b" style="background-image: url(./assets/wallpapers/color1b.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color2" style="background-image: url(./assets/wallpapers/color2.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color3" style="background-image: url(./assets/wallpapers/color3.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color4" style="background-image: url(./assets/wallpapers/color4.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color5" style="background-image: url(./assets/wallpapers/color5.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color6" style="background-image: url(./assets/wallpapers/color6.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color7" style="background-image: url(./assets/wallpapers/color7.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color8" style="background-image: url(./assets/wallpapers/color8.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color9" style="background-image: url(./assets/wallpapers/color9.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>
			<div class="selectwallpaper"  data-id="color10" style="background-image: url(./assets/wallpapers/color10.jpg);"><img src="./assets/icons/checkedimg.svg" class="checkedimg"></div>

		</div>
	</div>

	<br>
	<h3>Anzeigekonfiguration</h3>

	<div class="listcontainer">
		
		<div class="listitem listswicthitem">
			<div class="switchitemtext">Navigation anzeigen</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="navbar-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="switchitemtext">Uhr anzeigen</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="clock-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="switchitemtext">S-Bahnen anzeigen</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="suburbans-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="switchitemtext">Zugnummern anzeigen</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="trainnumber-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="switchitemtext">Remarks anzeigen</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="remarks-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>


	</div>

	<br>

	<h3>Steuerung</h3>

	<div class="listcontainer">
		<div class="listitem listswicthitem">
			<div class="switchitemtext">Touch-Eingabe deaktivieren</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="touch-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>
	</div>


	<br>

	<h3>Externe Dienste</h3>

	<div class="listcontainer">

		<div class="listitem listswicthitem">
			<div class="listimagecontainer"><img src="./assets/icons/appicons/google.svg" class="noinvert"></div>
			<div class="switchitemtext">Google Bildersuche<br><small class="disabled">Fahrzeugtypen können aus der Wagenreihung heraus in der Bildersuche geöffnet werden.</small></div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="google-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="listimagecontainer"><img src="./assets/icons/appicons/maps.svg" class="noinvert"></div>
			<div class="switchitemtext">Google Maps<br><small class="disabled">Adressen können durch tippen in der Google Maps Routensuche geöffnet werden.</small></div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="maps-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="listimagecontainer"><img src="./assets/icons/appicons/materialtrains.svg" class="noinvert"></div>
			<div class="switchitemtext">Material Trains<br><small class="disabled">Zugkonfigurationen werden als detailgetreue Grafiken in der Tripansicht angezeigt.</small></div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="materialtrains-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="listimagecontainer"><img src="./assets/icons/appicons/twlng.svg" class="noinvert"></div>
			<div class="switchitemtext">Träwelling<br><small class="disabled">Der aktuelle Träwelling-Check-In wird im Widget auf der Startseite angezeigt.</small><br>
				<small style="color: red;" id="notconected">● Nicht Verbunden</small>
				<div id="connect-button" class="button">
					Träwelling Konto verbinden
				</div>
			</div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="twlng-switch">
						<span class="slider round"></span>
					</label>
				</div>

				
			</div>
		</div>

		<div class="listitem listswicthitem">
			<div class="listimagecontainer"><img src="./assets/icons/appicons/webfis.svg" class="noinvert"></div>
			<div class="switchitemtext">webFIS<br><small class="disabled">Fahrtverlauf kann als webbasierter FIS-Screen wiedergeben werden.<br>Wird nur auf Desktop Viewports unterstützt.</small></div>
			<div class="listitemswitch">
				<div class="switchbox-container">
					<label class="onoffswitch">
						<input type="checkbox" id="webfis-switch">
						<span class="slider round"></span>
					</label>
				</div>
			</div>
		</div>
	</div>

	<br>

	<h3>Entwickler-Optionen</h3>
	<div class="listcontainer">
		<div class="listitem listswicthitem">
			<div class="switchitemtext"><a href="expert.html" class="black">Legacy Anzeigekonfiguration öffnen</a></div>
			<div class="listimagecontainer">
				<a href="expert.html"><img src="./assets/icons/arrow-right.svg"></a>
			</div>
		</div>
	</div>


</div>
	
</center>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const switches = [
        // Konfiguration für jeden Switch
		{ id: 'random-switch', storageKey: 'randomimg', defaultState: false },
        { id: 'navbar-switch', storageKey: 'shownavbar', defaultState: true },
        { id: 'clock-switch', storageKey: 'showclock', defaultState: true },
        { id: 'suburbans-switch', storageKey: 'showsuburbans', defaultState: false },
		{ id: 'trainnumber-switch', storageKey: 'showtrainnumbers', defaultState: false },
		{ id: 'remarks-switch', storageKey: 'showremarks', defaultState: false },
		{ id: 'touch-switch', storageKey: 'disabletouch', defaultState: false },
		{ id: 'materialtrains-switch', storageKey: 'materialtrains', defaultState: true },
		{ id: 'webfis-switch', storageKey: 'webfis', defaultState: true },
		{ id: 'google-switch', storageKey: 'google', defaultState: true },
		{ id: 'maps-switch', storageKey: 'maps', defaultState: true },
		{ id: 'twlng-switch', storageKey: 'twlng', defaultState: true }
    ];

    switches.forEach(sw => {
        const element = document.getElementById(sw.id);
        
        // Funktion zur Aktualisierung des Zustands
        const updateSwitchState = () => {
            // Speichert "true" oder "false" als Textwert
            const value = element.checked ? "true" : "false";
            localStorage.setItem(sw.storageKey, value);
            console.log(`${sw.storageKey} changed to: ${value}`);
        };

        // Zustand aus localStorage laden
        const storedValue = localStorage.getItem(sw.storageKey);
        
        if (storedValue === null) {
            // Wenn kein Wert im localStorage, verwende den Standardwert
            element.checked = sw.defaultState;
            localStorage.setItem(sw.storageKey, element.checked ? "true" : "false");
            console.log(`No stored value for ${sw.storageKey}. Defaulting to: ${sw.defaultState}`);
        } else {
            // Setze den Switch auf den gespeicherten Wert
            element.checked = storedValue === "true";
        }
        
        // Event-Listener für Klicks hinzufügen
        element.addEventListener('change', updateSwitchState);
    });

});

//Wallpaper Select

const images = document.querySelectorAll('.selectwallpaper');
    const selectedWallpaper = 'selectedWallpaper';

    function selectImage(id) {
      images.forEach(img => img.classList.toggle('selected', img.dataset.id === id));
      localStorage.setItem(selectedWallpaper, id);

    }

    images.forEach(img => {

		if (localStorage.getItem("randomimg") === "true") {
			img.addEventListener('click', () => {
				selectImage(img.dataset.id);
				localStorage.removeItem("randomimg");
				location.reload();
			});
		} else {
			img.addEventListener('click', () => {
				selectImage(img.dataset.id);
			});
		}
		
	});


    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem(selectedWallpaper);
      if (saved) {
        selectImage(saved);
      } else {
        selectImage(images[0].dataset.id);
      }
    });


	const randomSwitch = document.getElementById("random-switch");

randomSwitch.checked = localStorage.getItem("randomimg") === "true";

randomSwitch.addEventListener("change", () => {
  const isRandomActive = localStorage.getItem("randomimg") === "true";
  if (!isRandomActive && randomSwitch.checked) {
    localStorage.setItem("randomimg", "true");
    localStorage.setItem("selectedWallpaper", "unset");
    location.reload();
  }

  if (isRandomActive) {
    localStorage.removeItem("randomimg");
    localStorage.removeItem("selectedWallpaper");
    location.reload();
  }
});


//Träwelling Integration
if (localStorage.getItem('twlng') === 'false') {
		document.getElementById('connect-button').classList.add('hidden')
	}

	async function checkConnection() {
		const connectBtn = document.getElementById('connect-button');
		const accessToken = localStorage.getItem('accessToken');
		connectBtn.addEventListener('click', (event) => {
			event.preventDefault();

			// 2) Popup öffnen
			window.open(
					'https://data.cuzimmartin.dev/v1/traewelling/login',
					'TräwellingLogin',
					'width=600,height=700'
			);
		});

		try {
			// 3) Anfrage an Backend, ob schon verbunden
			const response = await fetch('https://data.cuzimmartin.dev/v1/traewelling/connection-status', {
				headers: {
					'Authorization': 'Bearer ' + accessToken
				}
			});

			// Wenn ok response -> Standard Text
			if (!response.ok) {
				return;
			}

			// 4) Ergebnis auswerten
			const result = await response.json(); // z.B. { connected: true } oder false
			if (result.connected) {
				// Bereits verbunden => Button-Text anpassen
				connectBtn.innerHTML = '<small style="color: green;" id="notconected">● Verbindung aktiv</small>';
				connectBtn.classList.remove('twlngbutton');
				connectBtn.classList.remove('button');
				connectBtn.onclick = null;

				document.getElementById('notconected').classList.add('hidden')
			}
		} catch (err) {
			console.error('Fehler beim Verbindungscheck:', err);
		}
	}

	// Beim Laden der Seite ausführen
	document.addEventListener('DOMContentLoaded', checkConnection);

</script>

</body>
</html>